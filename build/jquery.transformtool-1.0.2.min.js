/*! jQuery.transformTool v1.0.2 https://github.com/soloproyectos/transformtool | https://raw.github.com/soloproyectos/transformtool/master/LICENSE */
(function(e){function r(e,t){this._point=e;this._vector=t}function i(e,t,n,r,i,s){this._align=[e,t];Kinetic.Circle.call(this,{radius:n,fill:r,stroke:i,strokeWidth:s,draggable:true})}function s(t,r){this._target=t;this._options=e.extend({},n,r);this._rotateHandler=null;this._border=null;this._selectedHandler=null;this._handlers=[];Kinetic.Group.call(this);var i=this._target.getParent();i.setDraggable(this._options["allow-move"]);this.createBorder();this.addHandler(s.LEFT,s.TOP,this._options["allow-scale"]);this.addHandler(s.RIGHT,s.TOP,this._options["allow-scale"]);this.addHandler(s.LEFT,s.BOTTOM,this._options["allow-scale"]);this.addHandler(s.RIGHT,s.BOTTOM,this._options["allow-scale"]);this.addHandler(s.CENTER,s.TOP,this._options["allow-resize"]);this.addHandler(s.LEFT,s.MIDDLE,this._options["allow-resize"]);this.addHandler(s.RIGHT,s.MIDDLE,this._options["allow-resize"]);this.addHandler(s.CENTER,s.BOTTOM,this._options["allow-resize"]);this.createRotateHandler();this.update()}function o(n){return e(n).data(t+":tool")}function u(n,r){e(n).data(t+":tool",r)}function a(t,n){e.timer(0,function(){this.setDelay(1e3);var e=t.getStage();if(typeof e!="undefined"){this.stop();n.apply(t)}}).start()}function f(e,t){h(e,t,function(t){var n=e.getStage();var r=e.getParent();r.setDraggable(true);t.show();n.draw()})}function l(e,t){h(e,t,function(t){var n=e.getStage();var r=e.getParent();r.setDraggable(false);t.hide();n.draw()})}function c(e,t){h(e,t,function(t){if(t.getVisible()){l(e)}else{f(e)}})}function h(e,t,n){a(e,function(){var r=o(e);if(typeof r=="undefined"){r=p(e,t)}if(typeof n!="undefined"){n(r)}})}function p(e,t){var n=e.getParent();var r=new Kinetic.Group({x:e.getX()+e.getWidth()/2,y:e.getY()+e.getHeight()/2});n.add(r);e.remove();r.add(e);e.setPosition(0,0);e.setOffset({x:e.getWidth()/2,y:e.getHeight()/2});var i=new s(e,t);r.add(i);u(e,i);n.draw();return i}var t="transformTool";var n={"handler-radius":5,"handler-fill":"white","handler-stroke":"black","handler-stroke-width":2,"border-stroke":"black","border-stroke-width":2,"rotate-distance":35,"allow-rotate":true,"allow-scale":true,"allow-resize":true,"allow-move":true};r.prototype.getPoint=function(){return this._point};r.prototype.getVector=function(){return this._vector};Kinetic.Util.extend(i,Kinetic.Circle);i.prototype.getAlign=function(){return this._align};Kinetic.Util.extend(s,Kinetic.Group);s.LEFT=-1;s.CENTER=0;s.RIGHT=1;s.TOP=-1;s.MIDDLE=0;s.BOTTOM=1;s.prototype.getNearestPoint=function(e,t){var n=e.getPoint();var r=e.getVector();var i=((t.x-n.x)*r.x+(t.y-n.y)*r.y)/(Math.pow(r.x,2)+Math.pow(r.y,2));return{x:n.x+r.x*i,y:n.y+r.y*i}};s.prototype.getAngle=function(e){return Math.atan2(e.y,e.x)-Math.PI/2};s.prototype.createBorder=function(){this._border=new Kinetic.Line({points:[0,0],stroke:this._options["border-stroke"],strokeWidth:this._options["border-stroke-width"]});this.add(this._border)};s.prototype.createRotateHandler=function(){var e=this;this._rotateHandler=new Kinetic.Circle({radius:this._options["handler-radius"],fill:this._options["handler-fill"],stroke:this._options["handler-stroke"],strokeWidth:this._options["handler-stroke-width"],draggable:true,dragBoundFunc:function(t){if(this.isDragging()){var n=e.getParent();var r=n.getAbsolutePosition();var i={x:r.x-t.x,y:r.y-t.y};var s=e.getAngle(i);n.setRotation(s)}return t}});this._rotateHandler.setVisible(this._options["allow-rotate"]);this._rotateHandler.on("dragmove",function(){e.update()});this.add(this._rotateHandler);return this._rotateHandler};s.prototype.addHandler=function(e,t,n){var s=this;var o=new i(e,t,this._options["handler-radius"],this._options["handler-fill"],this._options["handler-stroke"],this._options["handler-stroke-width"]);var u={point:{x:0,y:0},vector:{x:0,y:0}};o.setVisible(n);o.setDragBoundFunc(function(e){if(this.isDragging()){e=s.getNearestPoint(u,e)}return e});o.on("mousedown",function(){var e=this.getAbsolutePosition();var t=s.getOppositeHandler(this).getAbsolutePosition();var n={x:t.x-e.x,y:t.y-e.y};s._selectedHandled=this;u=new r(e,n)});o.on("mouseup",function(){s._selectedHandled=null});o.on("dragmove",function(){s.apply();s.update()});this.add(o);this._handlers.push(o);return o};s.prototype.apply=function(){var e=this._selectedHandled.getPosition();var t=this._selectedHandled.getAlign();var n=t[0]!=0?Math.abs(2*e.x):this._target.getWidth();var r=t[1]!=0?Math.abs(2*e.y):this._target.getHeight();this._target.setSize(n,r);this._target.setOffset(n/2,r/2)};s.prototype.getHandlerByAlign=function(t,n){var r=null;e.each(this._handlers,function(){var e=this.getAlign();if(e[0]==t&&e[1]==n){r=this;return false}});return r};s.prototype.getOppositeHandler=function(e){var t=e.getAlign();return this.getHandlerByAlign(-t[0],-t[1])};s.prototype.update=function(){var e=this._target.getX()-this._target.getOffsetX();var t=this._target.getY()-this._target.getOffsetY();var n=this._target.getWidth();var r=this._target.getHeight();var i={x:e+n/2,y:t-this._options["rotate-distance"]};var o={x:e,y:t};var u={x:e+n,y:t};var a={x:e,y:t+r};var f={x:e+n,y:t+r};var l={x:e+n/2,y:t};var c={x:e,y:t+r/2};var h={x:e+n,y:t+r/2};var p={x:e+n/2,y:t+r};var d=[l,o,a,f,u,l];if(this._options["allow-rotate"]){d.unshift(i)}this._border.setPoints(d);this._rotateHandler.setPosition(i);this.getHandlerByAlign(s.LEFT,s.TOP).setPosition(o);this.getHandlerByAlign(s.RIGHT,s.TOP).setPosition(u);this.getHandlerByAlign(s.LEFT,s.BOTTOM).setPosition(a);this.getHandlerByAlign(s.RIGHT,s.BOTTOM).setPosition(f);this.getHandlerByAlign(s.CENTER,s.TOP).setPosition(l);this.getHandlerByAlign(s.LEFT,s.MIDDLE).setPosition(c);this.getHandlerByAlign(s.RIGHT,s.MIDDLE).setPosition(h);this.getHandlerByAlign(s.CENTER,s.BOTTOM).setPosition(p)};var d={init:function(e){return this.each(function(){var t=o(this);if(typeof t!="undefined"){f(this,e)}else{h(this,e)}})},hide:function(e){return this.each(function(){l(this,e)})},show:function(e){return this.each(function(){f(this,e)})},toggle:function(e){return this.each(function(){c(this,e)})}};e.fn[t]=function(t){var n=null;if(typeof t=="string"){var r=Array.prototype.slice.call(arguments,1);var i=d[t];if(typeof i=="undefined"){e.error("Method not found: "+t)}n=i.apply(this,r)}else{n=d.init.apply(this,arguments)}return n}})(jQuery)
